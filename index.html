<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>EdgeLab — Betting Workbench (Educational)</title>
<meta name="description" content="Private football betting workbench: odds → probability → EV → Kelly sizing. Single-file app we keep editing."/>
<style>
  /* ===== Theme ===== */
  :root{
    --bg: #0b1020;
    --bg-soft:#0f172a;
    --panel:#111827;
    --card:#0f172a;
    --text:#e5e7eb;
    --muted:#94a3b8;
    --border: #1f2937;
    --brand: #10b981; /* emerald */
    --brand-2:#22d3ee; /* cyan */
    --danger:#ef4444;
    --radius:16px;
    --shadow: 0 10px 30px rgba(0,0,0,.25);
  }
  body.light{
    --bg:#f7fafc; --bg-soft:#f8fafc; --panel:#ffffff; --card:#ffffff; --text:#0f172a; --muted:#64748b; --border:#e5e7eb; --shadow: 0 6px 18px rgba(2,8,23,.06);
  }
  html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
  a{color:inherit}
  .wrap{max-width:1200px;margin:0 auto;padding:20px}
  .glass{background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.04));border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow)}
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .grid{display:grid;gap:16px}
  @media(min-width:1024px){ .grid-12{grid-template-columns:repeat(12,minmax(0,1fr));} .col-4{grid-column:span 4} .col-8{grid-column:span 8}}
  .col-4,.col-8{grid-column:span 12}
  /* Header */
  .hero{
    position:sticky;top:0;z-index:30;
    background:linear-gradient(90deg,#0ea5e9, #10b981 60%, #22c55e);
    color:white;border-bottom:1px solid rgba(255,255,255,.15)
  }
  .hero .wrap{padding:14px 20px}
  .brand{display:flex;align-items:center;gap:10px;font-weight:700}
  .logo{width:28px;height:28px;border-radius:8px;background:radial-gradient(100% 100% at 20% 20%,#fff,rgba(255,255,255,.4));display:grid;place-items:center}
  .chip{display:inline-flex;align-items:center;gap:6px;background:rgba(255,255,255,.15);border:1px solid rgba(255,255,255,.25);border-radius:999px;padding:6px 10px;font-size:12px}
  /* Panels */
  .card{background:var(--card)}
  .card-h{padding:14px 16px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
  .card-b{padding:16px}
  .kpi{display:flex;justify-content:space-between;background:var(--bg-soft);border:1px dashed var(--border);border-radius:12px;padding:12px}
  /* Form */
  input[type='text'],input[type='number'],input[type='file']{
    height:40px;border-radius:12px;border:1px solid var(--border);background:transparent;color:var(--text);padding:0 12px;outline:none;width:100%;
  }
  input[type='number']::-webkit-outer-spin-button,input[type='number']::-webkit-inner-spin-button{ -webkit-appearance:none;margin:0;}
  label{color:var(--muted);font-size:12px}
  .btn{height:40px;padding:0 14px;border-radius:12px;border:1px solid var(--border);background:transparent;color:var(--text);cursor:pointer}
  .btn:hover{transform:translateY(-1px)}
  .btn.primary{background:linear-gradient(90deg,var(--brand),var(--brand-2));border-color:transparent;color:#001b14;font-weight:700}
  .btn.ghost{background:transparent}
  .btn.danger{border-color:var(--danger);color:var(--danger)}
  .muted{color:var(--muted);font-size:12px}
  /* Table */
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px 12px;border-bottom:1px solid var(--border);text-align:left}
  thead th{position:sticky;top:0;background:var(--panel);z-index:5}
  tbody tr:hover{background:rgba(255,255,255,.04)}
  .pill{display:inline-block;padding:4px 10px;border-radius:999px;font-size:12px}
  .pill.ok{background:rgba(16,185,129,.18);color:#34d399}
  .pill.no{background:rgba(148,163,184,.18);color:#94a3b8}
  .green{color:#34d399}
  /* Footer */
  .foot{margin-top:18px;padding:14px;color:var(--muted);text-align:center}
  /* Small utilities */
  .w-80{width:80px}.w-100{width:100px}.w-140{width:140px}.mb-8{margin-bottom:8px}.mt-8{margin-top:8px}
</style>
</head>
<body class="light"><!-- toggle to dark by removing 'light' -->
  <!-- Hero -->
  <div class="hero">
    <div class="wrap row" style="justify-content:space-between">
      <div class="brand">
        <div class="logo">⚽</div>
        <div>EdgeLab — Private Football Betting</div>
      </div>
      <div class="row">
        <span class="chip">Educational only</span>
        <button id="themeToggle" class="btn" style="height:32px;border-color:rgba(255,255,255,.4);color:white">Toggle theme</button>
      </div>
    </div>
  </div>

  <main class="wrap grid grid-12">
    <!-- Settings -->
    <div class="glass card col-4">
      <div class="card-h">
        <strong>Bankroll & Sizing</strong>
        <div class="row">
          <button id="saveState" class="btn" style="height:32px">Save</button>
        </div>
      </div>
      <div class="card-b grid" style="gap:12px">
        <div>
          <label>Currency</label>
          <input id="currency" type="text" value="$" class="w-80"/>
        </div>
        <div>
          <label>Bankroll</label>
          <input id="bankroll" type="number" value="1000"/>
        </div>
        <div>
          <label>Kelly fraction</label>
          <input id="kelly" type="number" step="0.05" value="0.25"/>
        </div>
        <div>
          <label>Per-bet cap</label>
          <input id="cap" type="number" step="0.005" value="0.02"/>
        </div>

        <div class="row">
          <button id="exportState" class="btn">Export</button>
          <label for="importStateInput" class="btn ghost">Import</label>
          <input id="importStateInput" type="file" accept="application/json" style="display:none"/>
          <button id="resetState" class="btn danger">Reset</button>
        </div>

        <div class="kpi">
          <div>
            <div class="muted">Total stake (approved)</div>
            <div id="totals" style="font-weight:700">—</div>
          </div>
          <div>
            <div class="muted">Tips</div>
            <div class="muted">Use decimals (e.g., 2.40)</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Calculator -->
    <div class="glass card col-8">
      <div class="card-h">
        <strong>Odds → EV → Stake</strong>
        <div class="row">
          <button class="btn" id="add">+ Add Fixture</button>
          <button class="btn primary" id="applyElo">Auto-fill probs (Elo)</button>
        </div>
      </div>
      <div class="card-b">
        <div id="fixtures"></div>
        <div style="overflow:auto; margin-top:12px">
          <table id="results">
            <thead>
              <tr>
                <th>Fixture</th>
                <th>Market p(H/D/A)</th>
                <th>My p(H/D/A)</th>
                <th>EV% (H/D/A)</th>
                <th>Stake (H/D/A)</th>
                <th>Decision</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Elo Trainer -->
    <div class="glass card col-12">
      <div class="card-h">
        <strong>Elo Trainer (CSV upload)</strong>
        <span class="muted">CSV: Date, HomeTeam, AwayTeam, FTHG, FTAG</span>
      </div>
      <div class="card-b row">
        <input id="csvFile" type="file" accept=".csv"/>
        <button id="trainElo" class="btn primary">Train Elo</button>
        <div id="eloSummary" class="muted">No data loaded yet.</div>
      </div>
    </div>

    <div class="foot muted">This tool is for education only. We’ll keep editing this same file.</div>
  </main>

<script>
  // ===== Utilities =====
  const clamp=(n,min=0,max=1)=>Math.max(min,Math.min(max,n));
  const fmtPct=x=>isFinite(x)?(x*100).toFixed(2)+'%':'-';
  const fmtMoney=(x,c='$')=>isFinite(x)?c+x.toFixed(2):'-';
  const implied=o=>o>0?1/o:0;
  const normalize=ps=>{const s=ps.reduce((a,b)=>a+b,0);return s>0?ps.map(p=>p/s):ps};
  const ev=(p,o)=>p*o-1;
  const kellyFull=(p,o)=>{const b=o-1,q=1-p,n=b*p-q;if(b<=0)return 0;return Math.max(0,n/b)};
  const fracKelly=(B,p,o,kf=0.25,cap=0.02)=>{const full=kellyFull(p,o);const used=kf*full;const capped=Math.min(used,cap);return{full,used,capped,stake:B*capped}};

  // ===== State & persistence =====
  const state={currency:'$',bankroll:1000,kelly:0.25,cap:0.02,fixtures:[],eloParams:{k:20,hfa:70,scale:400,base_draw:0.25,d_scale:500},ratings:{}};
  const LSKEY='edgelab_v1_state';
  function loadState(){const raw=localStorage.getItem(LSKEY);if(!raw)return;try{Object.assign(state,JSON.parse(raw));}catch{}}
  function saveState(){localStorage.setItem(LSKEY,JSON.stringify(state));}
  function exportState(){const blob=new Blob([JSON.stringify(state,null,2)],{type:'application/json'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='edgelab-state.json';a.click();URL.revokeObjectURL(url);}
  function resetState(){localStorage.removeItem(LSKEY);location.reload();}

  // ===== Elo =====
  const logistic=(x,scale=400)=>1/(1+Math.pow(10,-x/scale));
  const outcomeTriple=(hg,ag)=>hg>ag?'H':(hg<ag?'A':'D');
  function matchProbs(rHome,rAway,p){const{hfa,scale,base_draw,d_scale}=p;const diff=(rHome+hfa)-rAway;const ws=logistic(diff,scale);const pD=base_draw*Math.exp(-Math.abs(diff)/d_scale);const rem=1-pD;let pH=rem*ws,pA=rem*(1-ws);const s=pH+pD+pA;return{pH:pH/s,pD,pA:pA/s,diff}}
  function marginMult(hg,ag){const gd=Math.abs(hg-ag);return gd<=1?1:Math.log(1+gd)}
  function updateElo(rH,rA,hg,ag,p){const{k,hfa,scale}=p;const diff=(rH+hfa)-rA;const eH=logistic(diff,scale);const sH=hg>ag?1:(hg===ag?0.5:0);const mult=marginMult(hg,ag);return [rH+k*mult*(sH-eH), rA+k*mult*((1-sH)-(1-eH))];}
  function trainEloFromRows(rows,p){const teams=new Set();rows.forEach(r=>{teams.add(r.HomeTeam);teams.add(r.AwayTeam)});const ratings={};teams.forEach(t=>ratings[t]=1500);rows.sort((a,b)=>new Date(a.Date)-new Date(b.Date));let logloss=0;for(const r of rows){const h=r.HomeTeam,a=r.AwayTeam,hg=+r.FTHG,ag=+r.FTAG;const{pH,pD,pA}=matchProbs(ratings[h],ratings[a],p);const y=outcomeTriple(hg,ag);const pr=y==='H'?pH:(y==='D'?pD:pA);logloss+=-Math.log(Math.max(pr,1e-12));const[nH,nA]=updateElo(ratings[h],ratings[a],hg,ag,p);ratings[h]=nH;ratings[a]=nA;}return{ratings,logloss};}

  // ===== DOM helpers =====
  const $=s=>document.querySelector(s);
  function renderFixtures(){
    const box=$("#fixtures"); box.innerHTML="";
    state.fixtures.forEach(f=>{
      const card=document.createElement('div'); card.className='glass card'; card.style.marginBottom='12px';
      card.innerHTML=`<div class="card-b">
        <div class="row mb-8">
          <input type="text" class="w-140" value="${f.homeTeam}" data-k="homeTeam"/>
          <span class="muted">vs</span>
          <input type="text" class="w-140" value="${f.awayTeam}" data-k="awayTeam"/>
          <button class="btn danger" data-act="remove">Delete</button>
        </div>
        <div class="row mb-8">
          <input type="number" step="0.01" class="w-100" value="${f.homeOdds}" data-k="homeOdds"/>
          <input type="number" step="0.01" class="w-100" value="${f.drawOdds}" data-k="drawOdds"/>
          <input type="number" step="0.01" class="w-100" value="${f.awayOdds}" data-k="awayOdds"/>
          <span class="muted">Odds H / D / A</span>
        </div>
        <div class="row">
          <input type="number" step="0.001" class="w-100" value="${f.myPH}" data-k="myPH"/>
          <input type="number" step="0.001" class="w-100" value="${f.myPD}" data-k="myPD"/>
          <input type="number" step="0.001" class="w-100" value="${f.myPA}" data-k="myPA"/>
          <button class="btn" data-act="rebalance">Rebalance 100%</button>
          <span class="muted">My p(H/D/A)</span>
        </div>
      </div>`;
      card.querySelectorAll('input').forEach(inp=>{
        inp.addEventListener('input',()=>{
          const k=inp.getAttribute('data-k'); let v=inp.type==='number'?Number(inp.value):inp.value;
          if(['myPH','myPD','myPA'].includes(k)) v=clamp(v||0);
          const i=state.fixtures.findIndex(x=>x.id===f.id); state.fixtures[i][k]=v; renderResults();
        });
      });
      card.querySelector('[data-act="rebalance"]').addEventListener('click',()=>{
        const i=state.fixtures.findIndex(x=>x.id===f.id);
        const n=normalize([state.fixtures[i].myPH,state.fixtures[i].myPD,state.fixtures[i].myPA]);
        state.fixtures[i].myPH=n[0]; state.fixtures[i].myPD=n[1]; state.fixtures[i].myPA=n[2];
        renderFixtures(); renderResults();
      });
      card.querySelector('[data-act="remove"]').addEventListener('click',()=>{
        state.fixtures=state.fixtures.filter(x=>x.id!==f.id); renderFixtures(); renderResults();
      });
      box.appendChild(card);
    });
  }
  function compute(){
    const B=state.bankroll,kf=state.kelly,cap=state.cap,c=state.currency;
    let total=0,out=0;
    const rows=state.fixtures.map(f=>{
      const market=normalize([implied(+f.homeOdds),implied(+f.drawOdds),implied(+f.awayOdds)]);
      const eH=ev(+f.myPH,+f.homeOdds), eD=ev(+f.myPD,+f.drawOdds), eA=ev(+f.myPA,+f.awayOdds);
      const sH=fracKelly(B,+f.myPH,+f.homeOdds,kf,cap), sD=fracKelly(B,+f.myPD,+f.drawOdds,kf,cap), sA=fracKelly(B,+f.myPA,+f.awayOdds,kf,cap);
      const bet=(e,s)=>e>0&&s.stake>0;
      if(bet(eH,sH)){ total+=sH.stake; out++; }
      if(bet(eD,sD)){ total+=sD.stake; out++; }
      if(bet(eA,sA)){ total+=sA.stake; out++; }
      return {f,market,ev:{H:eH,D:eD,A:eA},stakes:{H:sH,D:sD,A:sA},c};
    });
    $("#totals").textContent=`${fmtMoney(total,c)} · ${out} outcomes`;
    return rows;
  }
  function renderResults(){
    const tbody=$("#results tbody"); tbody.innerHTML="";
    const rows=compute();
    rows.forEach(({f,market,ev,stakes,c})=>{
      const any=(ev.H>0&&stakes.H.stake>0)||(ev.D>0&&stakes.D.stake>0)||(ev.A>0&&stakes.A.stake>0);
      const tr=document.createElement('tr');
      tr.innerHTML=
        `<td>${f.homeTeam||'Home'} vs ${f.awayTeam||'Away'}</td>
         <td>${fmtPct(market[0])} / ${fmtPct(market[1])} / ${fmtPct(market[2])}</td>
         <td>${fmtPct(f.myPH)} / ${fmtPct(f.myPD)} / ${fmtPct(f.myPA)}</td>
         <td><div><div ${ev.H>0?'class="green"':''}>H: ${(ev.H*100).toFixed(2)}%</div>
                  <div ${ev.D>0?'class="green"':''}>D: ${(ev.D*100).toFixed(2)}%</div>
                  <div ${ev.A>0?'class="green"':''}>A: ${(ev.A*100).toFixed(2)}%</div></div></td>
         <td><div><div ${ev.H>0?'class="green"':''}>H: ${fmtMoney(stakes.H.stake,c)}</div>
                  <div ${ev.D>0?'class="green"':''}>D: ${fmtMoney(stakes.D.stake,c)}</div>
                  <div ${ev.A>0?'class="green"':''}>A: ${fmtMoney(stakes.A.stake,c)}</div></div></td>
         <td>${any?'<span class="pill ok">BET selective</span>':'<span class="pill no">NO BET</span>'}</td>`;
      tbody.appendChild(tr);
    });
  }
  function renderSettings(){
    document.getElementById('currency').value=state.currency;
    document.getElementById('bankroll').value=state.bankroll;
    document.getElementById('kelly').value=state.kelly;
    document.getElementById('cap').value=state.cap;
  }
  function addFixture(obj){
    const row=Object.assign({id:crypto.randomUUID(),homeTeam:'Alpha FC',awayTeam:'Gamma City',homeOdds:2.2,drawOdds:3.4,awayOdds:3.6,myPH:0.48,myPD:0.27,myPA:0.25},obj||{});
    state.fixtures.push(row); renderFixtures(); renderResults();
  }
  function applyEloToFixtures(){
    if(!Object.keys(state.ratings).length){ alert('Train Elo first (upload CSV → Train Elo).'); return; }
    for(const f of state.fixtures){
      const rH=state.ratings[f.homeTeam]??1500; const rA=state.ratings[f.awayTeam]??1500;
      const {pH,pD,pA}=matchProbs(rH,rA,state.eloParams);
      f.myPH=pH; f.myPD=pD; f.myPA=pA;
    }
    renderFixtures(); renderResults();
  }

  // ===== Events =====
  document.getElementById('themeToggle').addEventListener('click',()=>{document.body.classList.toggle('light');});
  document.getElementById('currency').addEventListener('input',e=>{state.currency=e.target.value.slice(0,3); renderResults();});
  document.getElementById('bankroll').addEventListener('input',e=>{state.bankroll=Number(e.target.value)||0; renderResults();});
  document.getElementById('kelly').addEventListener('input',e=>{state.kelly=Number(e.target.value)||0; renderResults();});
  document.getElementById('cap').addEventListener('input',e=>{state.cap=Number(e.target.value)||0; renderResults();});
  document.getElementById('add').addEventListener('click',()=>addFixture());
  document.getElementById('applyElo').addEventListener('click',applyEloToFixtures);
  document.getElementById('saveState').addEventListener('click',()=>{saveState(); alert('Saved locally.');});
  document.getElementById('exportState').addEventListener('click',exportState);
  document.getElementById('importStateInput').addEventListener('change',e=>{
    const file=e.target.files[0]; if(!file) return;
    const reader=new FileReader();
    reader.onload=()=>{ try{ Object.assign(state,JSON.parse(reader.result)); renderSettings(); renderFixtures(); renderResults(); alert('Imported.'); }catch{ alert('Invalid JSON.'); } };
    reader.readAsText(file);
  });
  document.getElementById('resetState').addEventListener('click',()=>{ if(confirm('Reset everything?')) resetState(); });

  // Train Elo
  document.getElementById('trainElo').addEventListener('click',async()=>{
    const file=document.getElementById('csvFile').files[0];
    if(!file){ alert('Choose a CSV first.'); return; }
    const text=await file.text();
    const lines=text.replace(/\r\n/g,'\n').replace(/\r/g,'\n').split('\n').filter(Boolean);
    const header=lines.shift().split(',').map(h=>h.trim());
    const rows=lines.map(line=>{ const cells=line.split(',').map(x=>x.trim()); const obj={}; header.forEach((h,i)=>obj[h]=cells[i]); return obj; });
    for(const r of rows){ for(const k of ['Date','HomeTeam','AwayTeam','FTHG','FTAG']){ if(!(k in r)){ alert('CSV missing column: '+k); return; } } }
    const {ratings,logloss}=trainEloFromRows(rows,state.eloParams);
    state.ratings=ratings; saveState();
    const teams=Object.keys(ratings).sort((a,b)=>ratings[b]-ratings[a]);
    const top=teams.slice(0,5).map(t=>`${t}: ${ratings[t].toFixed(1)}`).join(' · ');
    document.getElementById('eloSummary').textContent=`Teams: ${teams.length}. LogLoss: ${logloss.toFixed(2)}. Top: ${top}`;
    alert('Elo trained. Use “Auto-fill probs (Elo)”.');
  });

  // Init
  loadState(); renderSettings();
  if(state.fixtures.length===0) addFixture(); else { renderFixtures(); renderResults(); }
</script>
</body>
</html>
